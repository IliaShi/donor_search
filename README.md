# Детекция угла поворота для сервиса DonorSearch (задача многоклассовой классификации).

## Описание проекта
**Заказчик**: благотворительная организация [DonorSearch](https://donorsearch.org/), занимается продвижением донорства в РФ. На платформе DonorSearch для доноров доступны бонусная программа, игрофикация пути донора и многое другое. Важной является проверка честности доноров и корректности внесенных донаций. Подтверждение производится по справке установленной формы (№405), такую справку донор получает в центре крови и загружает в личный кабинет в формате изображения. На следующем этапе  с помощью сервиса OCR (optical character recognition) происходит распознавание табличной информации на бланке справки. Существующая версия сервиса требует вертикальной ориентации справки.

## Цель
Разработать модель для определения ориентации справки и автоматического поворота ее в нормальное положение.  

Условия технического задания:
* предполагается классификация изображений на 4 класса в зависимости от угла поворота (0, 90, 180, 270 градусов).  
* необходимо создать микросервис на базе Docker, входные данные - путь к изображению, выхоные данные - np.array или Pillow.Image.
* инференс на CPU. 
* метрика - accuracy, пороговое значение не установлено. 
* также необходимо построить ROC-кривые и матрицу ошибок для лучшей модели.

## Структура репозитория:

| #    | Наименование файла  | Описание |
| ---- | --- | --- |
| 1.   | [README.md](https://github.com/IliaShi/donor_search/blob/main/README.md) | Представлена основная информация по проекту и его результатах |
| 2.   | [rotation_angle_detection.ipynb](https://github.com/IliaShi/donor_search/blob/main/rotation_angle_detection.ipynb) | Тетрадка с основным решением |
| 3.   | [data_preparation.ipynb](https://github.com/IliaShi/donor_search/blob/main/data_preparation.ipynb) | Тетрадка для подготовки датасета |
| 4.   | [experiments.ipynb](https://github.com/IliaShi/donor_search/blob/main/experiments.ipynb) | Тетрадка с экспериментами и поиском решения |
| 5.   | [own_functions.py](https://github.com/IliaShi/donor_search/blob/main/own_functions.py) | Собственные функции для файла rotation_angle_detection.ipynb  |
| 6.   | [requirements.txt](https://github.com/IliaShi/donor_search/blob/main/requirements.txt) | Список зависимостей для проекта |
| 7.   | [Dockerfile](https://github.com/IliaShi/donor_search/blob/main/app/Dockerfile) | Докер-файл для запуска приложения |
| 8.   | [requirements.txt](https://github.com/IliaShi/donor_search/blob/main/app/requirements.txt) | Список зависимостей для Docker-файла |
| 9.   | [app.py](https://github.com/IliaShi/donor_search/blob/main/app/scr/app.py) |Скрипт для запуска приложения |

## Данные

Заказчиком предоставлено 173 изображения. Разметка данных отсутствует. 

Выводы по анализу и подготовке данных.  
1. Имеем небольшого размера исходный датасет из 173 изображений со справками разного вида и скриншотами из Госуслуг.
2. На всех изображениях имеются искусственные артефакты в виде белых прямоугольников - возможная помеха для работы модели.
3. Датасет увеличен в 4 раза до 692 изображений за счет поворота каждого исходного изображения на 0, 90, 180, 270 градусов. Изображения с соответствущим углом поворота размещены по подкаталогам с меткой класса.

## Поиск наилучшего решения

Изучено влияние артефактов ("белых прямоугольников") на работу модели ResNet50. При обучении на датасете с удаленными артефактами метрика снижалась на 4%. Т.о. сделан вывод, что модель использует артефакты как признак, обучение в дальнейшем проводилось на датасете без артефактов.  

В проекте использовались ResNet50 и VGG11 с предобученными весами и разморозкой и дообучение трех последних слоев.   
Обе модели показали высокие значения accuracy на валидационной выборке: ResNet - 0.98, VGG - 1.0. Инференс моделей при этом был сопоставим. Выбрана модель VGG за счет более высокой метрики качества.

Обученная модель упакована в контейнер Docker для последующей интеграции в продукт заказчика. 

## Итоги

**Основные выводы:**  
1. Для обучения использован датасет, предоставленный заказчиком (173 изображения). Количество изображений увеличено в 4 раза за счет поворта на 90, 180, 270 градусов каждого исходного изображения.
2. На исходных изображения от заказчика с помощью графического редктора удалены артефакты в виде белых прямоугольников, скрывающих персональные данные (экспериментально установлено, что данные артефакты снижают точность модели).
3. Обучены две модели: на основе ResNet-50 и VGG-11 с предобученными весами. Три последних слоя моделей разморожены и дообучены. 
4. Обучение на цветных изображениях 128х128, размер батча 64, эпох 10.
5. Обе модели показали высокие значения accuracy на валидационной выборке: ResNet - 0.98, VGG - 1.0. Инференс моделей при этом был сопоставим. Выбрана модель VGG за счет более высокой метрики качества.
6. Точность модели на основе VGG проверена на тестовой выборке: accuracy - 0.98, AUC - 0.99. Ошибки модели зафиксированы для изображений с углом поворта 0 и 90 градусов.
7. Разработан функционирующий микросервис на базе FastAPI, позволяющий определять угол поворта загруженной справки и возвращать правильно ориентированное изображение. Решение упаковано в контейнер Docker. 

**Проект может быть развит в следующих направлениях:**
  
   * **Обучение моделей на датасете большего размера:**  Обучение моделей на большем датасете может улучшить их качество и обобщающую способность.
   * **Обучение моделей на датасете без скрытия личных данных:** Так как на данных изображениях личные данные были скрыты, а на реальных справках данные остаются, было предположено, что это влияет на качество модели.


## Cтатус: 
Завершён.

## Стэк:
- PyTorch 
- numpy 
- matplotlib
- seaborn 
- pillow
- open-cv
- scikit-learn 
- fastapi 
- docker 

## Команда проекта
- [Илья Широких](https://github.com/IliaShi)
- [Гульшат Зарипова](https://github.com/gulshart)

